<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Xxk RMM Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --sidebar-bg: #ffffff;
            --sidebar-width: 280px;
            --bg-color: #f8fafc;
            --text-main: #334155;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --card-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        body { background: var(--bg-color); font-family: 'Inter', system-ui, -apple-system, sans-serif; height: 100vh; overflow: hidden; color: var(--text-main); font-size: 0.875rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* General Components */
        .btn { font-weight: 500; font-size: 0.85rem; padding: 0.375rem 0.75rem; border-radius: 6px; }
        .form-control, .form-select { font-size: 0.85rem; border-radius: 6px; padding: 0.375rem 0.6rem; border-color: var(--border-color); }
		.form-select {
			padding-right: 2rem !important;
			background-position: right 0.5rem center;
		}
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .card-custom { background: #fff; border-radius: 10px; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); display: flex; flex-direction: column; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar { background: var(--sidebar-bg); height: 100vh; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); width: var(--sidebar-width); z-index: 100; }
        .sidebar-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; height: 60px; }
        .client-list-scroll { flex: 1; overflow-y: auto; padding: 0; }
        
        .group-header { padding: 8px 12px; background: #f8fafc; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; font-weight: 700; color: #64748b; display: flex; align-items: center; cursor: pointer; position: relative;}
        .group-header:hover { background: #f1f5f9; color: var(--primary-color); }
        .group-actions {
			opacity: 0;
			transition: opacity 0.2s;
			margin-left: auto;
			display: flex;
			align-items: center;
		}
		.group-menu-trigger {
			padding: 4px 12px; 
			margin: -4px -8px -4px 0; 
			cursor: pointer;
			color: #94a3b8;
			transition: color 0.2s;
		}
		.group-menu-trigger:hover {
			color: var(--primary-color);
			background-color: rgba(0,0,0,0.05); 
			border-radius: 4px;
		}
		.group-node.root-virtual {
			border-bottom: 1px solid #f1f5f9;
		}
		.group-header:hover .group-actions { opacity: 1; }
		.drag-over { border: 2px dashed var(--primary-color); }
        .client-item { 
            padding: 8px 8px 8px 32px; 
            border-bottom: 1px solid #f8fafc; 
            cursor: pointer; 
            transition: background 0.15s; 
            display: flex; 
            align-items: center; 
            height: 48px;
        }
        .client-item:hover { background: #f1f5f9; }
        .client-item.active { background: #eff6ff; border-left: 4px solid var(--primary-color); padding-left: 28px; /* Keep visual alignment */ }
        
        .client-info-row { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; line-height: 1.2; }
        .client-name { font-weight: 500; color: var(--text-main); font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .client-ip-id { font-size: 0.75rem; color: #94a3b8; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-right: 8px; }
        .online { background: #10b981; } .offline { background: #cbd5e1; } .online-passive { background: #8b5cf6; }

        /* Fix: Increase menu button click area */
        .client-menu-btn { 
            width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; 
            color: #94a3b8; border-radius: 4px; 
            opacity: 0; transition: all 0.2s; 
			cursor: pointer;
        }
		.client-menu-btn.show {
            background: #e2e8f0; 
            color: var(--text-main);
            opacity: 1;
        }
        .client-item:hover .client-menu-btn { opacity: 1; }
        .client-menu-btn:hover { background: #e2e8f0; color: var(--text-main); }

        .dropdown-menu-sm { font-size: 0.8rem; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 4px 0; }
        .dropdown-item { padding: 6px 16px; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { height: 60px; border-bottom: 1px solid var(--border-color); background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0; }
        .workspace { padding: 16px; flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Tabs */
        .nav-tabs { border-bottom: 1px solid var(--border-color); padding: 0 16px; gap: 16px; background: #fff; }
        .nav-link { border: none !important; padding: 12px 4px; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; position: relative; transition: 0.2s; }
        .nav-link:hover { color: var(--primary-color); }
        .nav-link.active { color: var(--primary-color); font-weight: 600; }
        .nav-link.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--primary-color); }

        /* Terminal */
        .terminal-window { 
			background: #1e293b; color: #f8fafc; 
			font-family: 'JetBrains Mono', 'Consolas', monospace; 
			padding: 4px 12px 12px 12px;
			flex: 1; overflow-y: auto; 
			font-size: 0.85rem; line-height: 1.4; 
			white-space: pre-wrap; word-break: break-all;
		}

        /* File Manager */
        .file-manager { display: flex; height: 100%; }
        .file-tree { width: 220px; background: #f8fafc; border-right: 1px solid var(--border-color); padding: 12px; overflow-y: auto; }
        .tree-section { margin-bottom: 16px; }
        .tree-title { font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px; padding-left: 8px; }
        .tree-link { 
            display: flex; align-items: center; gap: 8px; 
            padding: 6px 10px; color: var(--text-secondary); 
            border-radius: 6px; cursor: pointer; 
            text-decoration: none; font-size: 0.85rem; transition: 0.1s; 
        }
        .tree-link:hover { background: #e2e8f0; color: var(--text-main); }
        
        .file-actions-cell { white-space: nowrap; }

        /* Batch Task */
        .batch-body { padding: 16px; flex: 1; overflow-y: auto; background: #fff; position: relative; }
        .batch-empty-state { 
			position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
			text-align: center; color: #cbd5e1; pointer-events: none;
			display: flex; flex-direction: column; align-items: center; justify-content: center;
		}
        .batch-item { animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* USB Audit */
        .filter-bar { padding: 16px; background: #fff; border-bottom: 1px solid var(--border-color); }
        .filter-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; display: block; font-weight: 600; }

        /* System Info */
        .sys-card { 
            background: #fff; border: 1px solid var(--border-color); 
            border-radius: 8px; padding: 16px; height: 100%; 
            display: flex; flex-direction: column; justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .sys-card:hover { transform: translateY(-2px); box-shadow: var(--card-shadow); border-color: #cbd5e1; }
        .sys-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .sys-value { font-size: 1rem; font-weight: 600; color: var(--text-main); word-break: break-word; }

        /* Functions */
        .function-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; padding: 20px; }
        .func-btn { 
            background: #fff; border: 1px solid var(--border-color); 
            border-radius: 8px; padding: 20px 10px; 
            text-align: center; cursor: pointer; transition: 0.2s; 
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .func-btn:hover { border-color: var(--primary-color); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); transform: translateY(-2px); }
        .func-btn i { font-size: 1.8rem; color: var(--text-secondary); transition: 0.2s; }
        .func-btn:hover i { color: var(--primary-color); transform: scale(1.1); }
        .func-btn span { font-size: 0.85rem; font-weight: 500; color: var(--text-main); }
        .func-btn.danger:hover { border-color: #ef4444; }
        .func-btn.danger:hover i { color: #ef4444; }

        .batch-action-bar { padding: 8px 16px; background: #f8fafc; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
		#globalConfirmModal {
			z-index: 1080 !important; 
		}
		.modal-backdrop.show:nth-of-type(2) {
			z-index: 1075 !important;
		}
		#groupRenameModal {
			z-index: 1090 !important; 
		}

		.modal-backdrop.show:nth-of-type(2) {
			z-index: 1085 !important;
		}
		
		.group-node { transition: all 0.2s; }
		.group-children { 
			margin-left: 18px; 
			border-left: 1px solid #e2e8f0; 
			display: block;
		}
		.group-children.collapsed { display: none; }
		img[src=""], img:not([src]) {
			display: none !important;
		}
    </style>
</head>
<body>

<div class="container-fluid p-0">
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-network-wired text-primary fs-5"></i>
                <h6 class="m-0 fw-bold">Xxk RMM <span class="badge bg-light text-secondary border ms-2 fw-normal">Pro</span></h6>
            </div>
            
            <div class="p-2 border-bottom">
				<!-- Search Box -->
				<div class="input-group input-group-sm mb-2">
					<span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
					<input type="text" id="clientSearchInput" class="form-control border-start-0 bg-light" placeholder="Search hosts..." onkeyup="filterClients()">
					<button class="btn btn-primary" onclick="showAddModal()"><i class="fas fa-plus"></i></button>
				</div>
				<!-- Status filter and refresh button -->
				<div class="d-flex gap-2">
					<select id="clientStatusFilter" class="form-select form-select-sm" onchange="filterClients()">
						<option value="all">All Status</option>
						<option value="online">Online Only</option>
						<option value="offline">Offline Only</option>
					</select>
					<button class="btn btn-light btn-sm border text-secondary" title="Refresh List" onclick="loadClients(this)">
                        <i class="fas fa-sync-alt"></i>
                    </button>
				</div>
			</div>

            <div id="clientListArea" class="client-list-scroll custom-scroll">
                <!-- Clients will be loaded here -->
            </div>

            <div class="batch-action-bar" id="batchActionBar">
                <div class="form-check m-0 small">
                    <input class="form-check-input" type="checkbox" id="selectAllClients" onchange="toggleAllClients(this)">
                    <label class="form-check-label text-muted" for="selectAllClients">Select All</label>
                </div>
                <div>
					<button class="btn btn-sm btn-light text-secondary" title="Collapse/Expand All" onclick="toggleAllGroups()"><i class="fas fa-compress-arrows-alt"></i></button>
					<button class="btn btn-sm btn-light text-primary" title="Device Inventory" onclick="openLedgerModal()"><i class="fas fa-table"></i></button>
                    <button class="btn btn-sm btn-light text-danger" title="Delete Selected" onclick="batchDeleteClients()"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
            
            <div class="border-top p-2 bg-light">
                 <div class="d-flex justify-content-between align-items-center px-2">
                    <small class="text-muted" id="totalClientCount">0 Hosts</small>
                    <a href="/logout" class="text-secondary text-decoration-none small"><i class="fas fa-sign-out-alt"></i></a>
                 </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-primary bg-opacity-10 text-primary rounded p-1 px-2">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <div>
                        <div class="fw-bold fs-6 lh-1" id="currentHostName">No host selected</div>
                        <div class="text-muted small font-monospace lh-1 mt-1" id="currentHostIp">---</div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                     <button class="btn btn-light border d-flex align-items-center gap-2" data-bs-toggle="dropdown">
						<i class="fas fa-history text-secondary"></i> 
						<span>Tasks</span>
						<span id="globalTaskCount" class="badge rounded-pill bg-danger bg-opacity-75 shadow-sm" style="display:none; font-weight: 500;">0</span>
					</button>
                    <div class="dropdown-menu dropdown-menu-end shadow border-0 p-0" style="width: 300px">
                        <div class="p-2 border-bottom bg-light fw-bold small">Background Task Center</div>
                        <div id="ongoingTaskList" style="max-height: 300px; overflow-y: auto;">
                            <div class="p-3 text-center text-muted small">No running tasks</div>
                        </div>
                    </div>
                    <button class="btn btn-light border" onclick="new bootstrap.Modal('#cfgModal').show()"><i class="fas fa-cog"></i> Settings</button>
                </div>
            </div>

            <div class="workspace">
                <div class="card-custom">
                    <ul class="nav nav-tabs" id="mainTab">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-screen">Desktop</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-cmd">Terminal</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-process">Process</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-files">Files</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-batch">Batch</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-usb">USB</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-sysinfo">Info</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-functions">Functions</a></li>
                    </ul>

                    <div class="tab-content flex-fill d-flex flex-column overflow-hidden">
                        
                        <!-- Screen -->
                        <div class="tab-pane fade show active h-100" id="tab-screen">
						<div class="d-flex flex-column h-100">
        
        <!-- Top Toolbar -->
        <div class="p-2 border-bottom bg-white d-flex justify-content-between align-items-center flex-shrink-0">
            <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm" id="btnStartMonitor" onclick="toggleScreen(true)" disabled>
                    <i class="fas fa-play me-1"></i> Start
                </button>
                <button class="btn btn-danger btn-sm" onclick="toggleScreen(false)">
                    <i class="fas fa-stop me-1"></i> Stop
                </button>
                <div class="vr my-1"></div>
                <span class="badge bg-secondary d-flex align-items-center" id="screenStatus">Stopped</span>
            </div>
            <div class="d-flex gap-2 align-items-center">
				<div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="controlToggle" disabled>
                    <label class="form-check-label small" for="controlToggle">Control</label>
                </div>
				<select id="qualitySelect" class="form-select form-select-sm" style="width: auto;" onchange="manualQualityChange()">
						<option value="auto">‚ö° Auto</option>
						<option value="low">üöÄ Smooth (30% / 0.5x)</option>
						<option value="medium">‚öñÔ∏è Standard (50% / 0.8x)</option>
						<option value="high" selected>HD High (80% / 1.0x)</option>
						<option value="ultra">üíé Original (95% / 1.0x)</option>
				</select>
            </div>
        </div>

        <!-- Screen Display Area -->
        <div class="flex-fill bg-light d-flex justify-content-center align-items-center overflow-hidden position-relative" 
             id="screenContainer" 
             tabindex="0"
             style="background-color: #2c2c2c;">
            
            <div id="screenPlaceholder" class="text-secondary text-center">
                <i class="fas fa-desktop fs-1 mb-3 opacity-25"></i>
                <div>Click Start to Monitor</div>
            </div>
            
            <img id="screenDisplay" src="" 
				 style="display:none; max-width: 100%; max-height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.1);" 
				 draggable="false"  
				 oncontextmenu="return false;"
				 onerror="this.style.display='none';"
				 onload="if(this.src && this.src.length > 100) { this.style.display='block'; document.getElementById('screenPlaceholder').style.display='none'; }">
        </div>

    </div>
</div>

                        <!-- CMD -->
                        <div class="tab-pane fade h-100" id="tab-cmd">
							 <div class="d-flex flex-column h-100">
								<div id="termOutput" class="terminal-window"><div>Waiting for command input...</div></div>
								<div class="p-1 bg-light border-top">
									<div class="input-group input-group-sm">
										<span class="input-group-text bg-dark text-light border-0 font-monospace" id="cmdPrompt">C:\></span>
										<input type="text" id="cmdInput" class="form-control font-monospace" onkeypress="if(event.key==='Enter') sendCmd()">
										<button class="btn btn-primary" onclick="sendCmd()">Send</button>
									</div>
								</div>
							 </div>
						</div>

                        <!-- Files -->
                        <div class="tab-pane fade h-100" id="tab-files">
                            <div class="file-manager">
                                <div class="file-tree">
                                    <div class="tree-section">
										<div class="tree-title">Drives</div>
										<div id="driveListContainer">
											<a class="tree-link" onclick="forceCd('C:\\\\')"><i class="fas fa-hdd text-secondary"></i> Local Disk (C:)</a>
											<a class="tree-link" onclick="forceCd('D:\\\\')"><i class="fas fa-hdd text-secondary"></i> Local Disk (D:)</a>
										</div>
									</div>
                                    <div class="tree-section">
                                        <div class="tree-title">Quick Access</div>
                                        <a class="tree-link" onclick="forceCd('%USERPROFILE%\\\\Desktop')"><i class="fas fa-desktop text-primary"></i> Desktop</a>
                                        <a class="tree-link" onclick="forceCd('%USERPROFILE%\\\\Downloads')"><i class="fas fa-download text-success"></i> Downloads</a>
                                        <a class="tree-link" onclick="forceCd('%USERPROFILE%\\\\Documents')"><i class="fas fa-file-alt text-warning"></i> Documents</a>
                                    </div>
                                    <div class="tree-section">
                                        <div class="tree-title">System Dirs</div>
                                        <a class="tree-link" onclick="forceCd('%APPDATA%')"><i class="fas fa-folder text-danger"></i> AppData</a>
                                        <a class="tree-link" onclick="forceCd('%TEMP%')"><i class="fas fa-trash-alt text-muted"></i> Temp</a>
                                    </div>
                                </div>
                                <div class="d-flex flex-column flex-fill bg-white">
                                    <div class="p-2 border-bottom d-flex gap-2 align-items-center">
                                        <button class="btn btn-light btn-sm border" onclick="goUp()"><i class="fas fa-level-up-alt"></i></button>
                                        <div class="input-group input-group-sm flex-fill">
                                            <span class="input-group-text bg-light"><i class="fas fa-folder-open text-warning"></i></span>
                                            <input type="text" id="filePath" class="form-control" value="C:\">
                                            <button class="btn btn-light border" onclick="cdToPath()"><i class="fas fa-arrow-right"></i></button>
                                        </div>
                                        <button class="btn btn-light btn-sm border" onclick="refreshFiles()"><i class="fas fa-sync-alt"></i></button>
                                        <input type="file" id="upFile" style="display:none" onchange="doUpload()">
                                        <button class="btn btn-primary btn-sm text-nowrap" onclick="document.getElementById('upFile').click()"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
                                    </div>
                                    <div class="flex-fill overflow-auto">
                                        <table class="table table-hover table-sm mb-0 align-middle">
                                            <thead class="table-light sticky-top"><tr><th class="ps-3">Name</th><th width="100">Size</th><th style="width: 150px; min-width: 150px;" class="text-end pe-3">Action</th></tr></thead>
                                            <tbody id="fileTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Batch -->
                        <div class="tab-pane fade h-100" id="tab-batch">
                            <div class="d-flex flex-column h-100 bg-light p-3 overflow-hidden">
                                <div class="row g-3 h-100">
                                    <div class="col-md-6 d-flex flex-column h-100">
                                        <div class="card-custom h-100">
                                            <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
                                                <h6 class="m-0 fw-bold"><i class="fas fa-terminal me-2 text-dark"></i>Batch Commands</h6>
                                                <button class="btn btn-sm btn-light border" onclick="addBatchCommand()"><i class="fas fa-plus text-primary"></i> Add</button>
                                            </div>
                                            <div class="batch-body" id="batchCommandList">
                                                <div class="batch-empty-state" id="batchCmdEmpty">
                                                    <i class="fas fa-code fs-1 mb-2 opacity-25"></i>
                                                    <small>No commands, click Add on top right</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 d-flex flex-column h-100">
                                        <div class="card-custom h-100">
                                            <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
                                                <h6 class="m-0 fw-bold"><i class="fas fa-file-export me-2 text-dark"></i>Batch Distribution</h6>
                                                <button class="btn btn-sm btn-light border" onclick="addBatchFile()"><i class="fas fa-plus text-primary"></i> Add</button>
                                            </div>
                                            <div class="batch-body" id="batchFileList">
                                                <div class="batch-empty-state" id="batchFileEmpty">
                                                    <i class="fas fa-copy fs-1 mb-2 opacity-25"></i>
                                                    <small>No files, click Add on top right</small>
                                                </div>
                                            </div>
                                            <div class="p-3 border-top bg-light">
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-auto"><small class="text-muted fw-bold">Settings:</small></div>
                                                    <div class="col"><div class="input-group input-group-sm"><span class="input-group-text">Threshold(MB)</span><input type="number" id="batchFileThreshold" class="form-control" value="{{.FileThreshold}}"></div></div>
                                                    <div class="col"><div class="input-group input-group-sm"><span class="input-group-text">Cache(Min)</span><input type="number" id="tempFileTTL" class="form-control" value="{{.TempFileTTL}}"></div></div>
                                                    <div class="col-auto"><button class="btn btn-primary btn-sm text-nowrap" onclick="saveServerSettings()">
														<i class="fas fa-save me-1"></i> Save
													</button></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-4 flex-shrink-0">
                                     <button class="btn btn-primary px-5 shadow-sm" onclick="executeBatchTask()"><i class="fas fa-paper-plane me-2"></i> Execute Batch Task</button>
                                </div>
                            </div>
                        </div>

                        <!-- USB -->
                        <div class="tab-pane fade h-100" id="tab-usb">
                             <div class="d-flex flex-column h-100">
                                <div class="filter-bar">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-3">
                                            <label class="filter-label">Date Range</label>
                                            <div class="input-group input-group-sm">
                                                <input type="date" id="usbStart" class="form-control">
                                                <span class="input-group-text">-</span>
                                                <input type="date" id="usbEnd" class="form-control">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="filter-label">Host</label>
                                            <select id="usbClientFilter" class="form-select form-select-sm"><option value="">All</option></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="filter-label">Keyword</label>
                                            <input type="text" id="usbKeyword" class="form-control form-control-sm" placeholder="Device Name / Serial...">
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-primary btn-sm me-1" onclick="usbPage=1; loadUSBRecords()"><i class="fas fa-search me-1"></i> Search</button>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" onclick="exportUSB('current')">Export Page</button>
                                                <button class="btn btn-outline-secondary" onclick="exportUSB('all')">Export All</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-fill overflow-auto bg-white">
                                    <table class="table table-hover table-sm mb-0 table-striped">
                                        <thead class="sticky-top bg-light text-secondary"><tr><th class="ps-3">Time</th><th>Host</th><th>Action</th><th>Device</th><th>Model</th><th>ID</th></tr></thead>
                                        <tbody id="usbRecordsBody"></tbody>
                                    </table>
                                </div>
                                <div class="p-2 border-top bg-light d-flex justify-content-between align-items-center">
                                    <small class="text-muted ms-2" id="usbPageInfo">Page 1</small>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm w-auto" id="usbPageSize" onchange="usbPage=1; loadUSBRecords()"><option value="20">20 rows</option><option value="50">50 rows</option><option value="100">100 rows</option></select>
                                        <div class="btn-group btn-group-sm"><button class="btn btn-white border" onclick="changeUsbPage(-1)"><</button><button class="btn btn-white border" onclick="changeUsbPage(1)">></button></div>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <!-- System Info -->
                        <div class="tab-pane fade h-100" id="tab-sysinfo">
                            <div class="p-4 bg-light h-100 overflow-auto">
                                <div class="row g-3">
                                    <div class="col-lg-3 col-md-6">
                                        <div class="sys-card">
                                            <div class="sys-label"><i class="fas fa-microchip me-1"></i> Processor</div>
                                            <div class="sys-value" id="cpuInfo">---</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="sys-card">
                                            <div class="sys-label"><i class="fas fa-memory me-1"></i> Memory</div>
                                            <div class="sys-value" id="memInfo">---</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="sys-card">
                                            <div class="sys-label"><i class="fab fa-windows me-1"></i> System</div>
                                            <div class="sys-value" id="osInfo">---</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="sys-card">
                                            <div class="sys-label"><i class="fas fa-clock me-1"></i> Client Time</div>
                                            <div class="sys-value" id="timeInfo">---</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="sys-card">
                                            <div class="sys-label"><i class="fas fa-hdd me-1"></i> Disk Status</div>
                                            <div class="sys-value font-monospace small" id="diskInfo">---</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="sys-card">
                                            <div class="sys-label"><i class="fas fa-network-wired me-1"></i> Network Interfaces</div>
                                            <div class="sys-value font-monospace small" id="netInfo">---</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-4">
                                    <button class="btn btn-light border px-4" onclick="loadSysInfo()"><i class="fas fa-sync-alt me-1"></i> Refresh Info</button>
                                </div>
                            </div>
                        </div>

                        <!-- Process -->
                         <div class="tab-pane fade h-100" id="tab-process">
                            <div class="d-flex flex-column h-100 bg-white">
                                <div class="p-2 border-bottom d-flex align-items-center bg-light gap-2">
                                    <input type="text" class="form-control form-control-sm flex-fill" placeholder="Search process..." onkeyup="filterPs(this.value)">
                                    <button class="btn btn-primary btn-sm flex-shrink-0" onclick="refreshPs()"><i class="fas fa-sync-alt"></i> Refresh</button>
                                </div>
                                <div class="flex-fill overflow-auto">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top"><tr><th class="ps-3">PID</th><th>Name</th><th>Memory (MB)</th><th class="text-end pe-3">Action</th></tr></thead>
                                        <tbody id="psTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Functions -->
                        <div class="tab-pane fade h-100" id="tab-functions">
                            <div class="h-100 overflow-auto bg-light">
                                <div class="function-grid">
                                    <div class="func-btn" onclick="execFunction('lock_screen')"><i class="fas fa-lock"></i><span>Lock Screen</span></div>
                                    <div class="func-btn" onclick="execFunction('logoff')"><i class="fas fa-user-slash"></i><span>Logoff User</span></div>
                                    <div class="func-btn" onclick="execFunction('enable_usb')"><i class="fas fa-check-circle text-success"></i><span>Enable USB</span></div>
                                    <div class="func-btn" onclick="execFunction('disable_usb')"><i class="fas fa-ban text-warning"></i><span>Disable USB</span></div>
                                    <div class="func-btn" onclick="execFunction('enable_printer')"><i class="fas fa-print text-success"></i><span>Enable Printer</span></div>
                                    <div class="func-btn" onclick="execFunction('disable_printer')"><i class="fas fa-ban text-warning"></i><span>Disable Printer</span></div>
                                    <div class="func-btn danger" onclick="execFunction('restart')"><i class="fas fa-redo"></i><span>Reboot System</span></div>
                                    <div class="func-btn danger" onclick="execFunction('shutdown')"><i class="fas fa-power-off"></i><span>Shutdown Now</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container"></div>
<!-- Upload Modal, Large File Modal, Add/Edit/Cfg/Group Modals -->
<div class="modal fade" id="uploadModal" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><h6 class="fw-bold mb-3">Uploading File</h6><div class="d-flex justify-content-between mb-1 small"><span id="uploadFileName"></span><span id="uploadPercent">0%</span></div><div class="progress mb-2" style="height:6px"><div id="uploadProgressBar" class="progress-bar"></div></div><div class="text-center small text-muted" id="uploadSizeInfo"></div><button class="btn btn-sm btn-outline-danger w-100 mt-3" onclick="cancelUpload()">Cancel</button></div></div></div></div>

<div class="modal fade" id="largeFileModal" data-bs-backdrop="static"><div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header py-2"><h6 class="m-0 fw-bold">Fast Distribution</h6></div><div class="modal-body p-0"><div id="stageUploadSection" class="p-4 text-center"><h6 class="mb-3 text-muted">Uploading to Server...</h6><div class="progress" style="height:10px"><div id="serverUploadBar" class="progress-bar progress-bar-striped progress-bar-animated"></div></div></div><div id="clientPullSection" style="display:none"><table class="table table-sm mb-0"><thead class="bg-light sticky-top"><tr><th class="ps-3">Host</th><th width="40%">Progress</th><th>Status</th><th></th></tr></thead><tbody id="largeFileTableBody"></tbody></table></div></div><div class="modal-footer py-1 bg-light"><button class="btn btn-primary btn-sm" data-bs-dismiss="modal" id="btnHideTask">Hide</button><button class="btn btn-outline-danger btn-sm" onclick="cancelAllLargeFile()" id="btnCancelTask">Cancel All</button></div></div></div></div>

<!-- Add Modal -->
<div class="modal fade" id="addModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold" id="modalTitle">Add Host</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editingIp"><input type="hidden" id="editMode"><div class="mb-2"><label class="small text-muted">IP:Port</label><input id="addIp" class="form-control"></div><div class="mb-2" id="idDisplayRow" style="display:none"><label class="small text-muted">ID</label><input id="addId" class="form-control bg-light" readonly></div><div class="mb-2"><label class="small text-muted">Alias</label><input id="addAlias" class="form-control"></div><div class="mb-2"><label class="small text-muted">Group</label><select id="addGroup" class="form-select"></select></div><div class="mb-2"><label class="small text-muted">Password</label><input id="addPass" class="form-control" value="{{.DefaultPass}}"></div></div><div class="modal-footer py-2"><button class="btn btn-primary w-100" onclick="saveClient()">Save</button></div></div></div></div>

<div class="modal fade" id="globalConfirmModal"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center py-4"><div id="globalConfirmMsg" class="fw-bold mb-3"></div><div class="d-flex gap-2 justify-content-center"><button class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button><button class="btn btn-danger btn-sm" id="globalConfirmBtn">Confirm</button></div></div></div></div></div>

<div class="modal fade" id="groupModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title fw-bold">Group</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="input-group mb-3"><input id="newGroupName" class="form-control" placeholder="New Group Name"><button class="btn btn-primary" onclick="addGroup()">+</button></div><div id="groupList" class="list-group list-group-flush border rounded"></div></div></div></div></div>

<div class="modal fade" id="cfgModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title fw-bold">Generate Config</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-2 mb-2"><div class="col-6"><small>Port</small><input id="cfgPort" class="form-control" value="{{.DefaultPort}}"></div><div class="col-6"><small>Password</small><input id="cfgPass" class="form-control" value="{{.DefaultPass}}"></div></div><div class="form-check mb-2"><input type="checkbox" id="cfgAutostart" class="form-check-input"><label class="form-check-label small">Auto Install Service</label></div><div class="form-check"><input type="checkbox" id="cfgPassiveMode" class="form-check-input"><label class="form-check-label small">Passive Mode</label></div><div id="passiveModeSettings" style="display:none" class="mt-2 ps-2 border-start"><div class="mb-1"><small>Server IP</small><input id="cfgServerAddr" class="form-control form-control-sm"></div><div class="row g-2"><div class="col-6"><small>Web Port</small><input id="cfgServerPort" class="form-control form-control-sm" value="8080"></div><div class="col-6"><small>Server Password</small><input id="cfgServerPass" class="form-control form-control-sm" value="{{.DefaultPass}}"></div></div>
	<div class="mt-2">
		<small>Passive Reconnect Interval (s)</small>
		<input id="cfgCheckInterval" type="number" class="form-control form-control-sm" value="10" min="5">
		<div class="text-muted" style="font-size: 0.7rem;">Recommended 10-30s. Smaller values recover faster after server restart.</div>
	</div>
</div></div><div class="modal-footer py-2"><button class="btn btn-success w-100" onclick="dlCfg()">Download</button></div></div></div></div>

<!-- Group Rename Modal -->
<div class="modal fade" id="groupRenameModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title fw-bold">Rename Group</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="renameOldName">
                <div class="mb-3">
                    <label class="form-label small text-muted">Old Name</label>
                    <input type="text" class="form-control form-control-sm bg-light" id="renameOldNameDisplay" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">New Name</label>
                    <input type="text" class="form-control" id="renameNewName" placeholder="Enter new name">
                </div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="confirmRenameGroup()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="groupActionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title fw-bold" id="groupActionTitle">Group Action</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ga_mode"> 
                <input type="hidden" id="ga_targetId"> 
                
                <div class="mb-3">
                    <label class="form-label small text-muted">Group Name</label>
                    <input type="text" class="form-control" id="ga_nameInput" placeholder="Enter name" onkeypress="if(event.key==='Enter') submitGroupAction()">
                </div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="submitGroupAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Device Ledger Modal -->
<div class="modal fade" id="ledgerModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2 bg-light">
                <h6 class="modal-title fw-bold"><i class="fas fa-table me-2"></i>Device Inventory</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 d-flex flex-column" style="height: 70vh;">
                <!-- Top Toolbar -->
                <div class="p-3 border-bottom bg-white">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3">
                            <input type="text" id="ledgerSearch" class="form-control form-control-sm" placeholder="Search Alias/IP/ID..." onkeyup="ledgerPage=1; renderLedgerTable()">
                        </div>
                        <div class="col-md-2">
                            <select id="ledgerFilter" class="form-select form-select-sm" onchange="ledgerPage=1; renderLedgerTable()">
                                <option value="all">All Hosts</option>
                                <option value="online">Online Only</option>
                                <option value="offline">Offline Only</option>
                            </select>
                        </div>
                        <div class="col-md-7 text-end">
                             <button class="btn btn-primary btn-sm me-2" onclick="refreshLedgerInfo()">
                                <i class="fas fa-sync-alt me-1"></i> Get Latest Info
                            </button>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="exportLedger('current')">Export Page</button>
                                <button class="btn btn-outline-secondary" onclick="exportLedger('all')">Export All</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Table Area -->
                <div class="flex-fill overflow-auto">
                    <table class="table table-hover table-sm mb-0 table-striped align-middle text-nowrap">
                        <thead class="sticky-top bg-light text-secondary">
                            <tr>
                                <th class="ps-3">Alias</th>
								<th>Group</th>
                                <th>IP</th>
                                <th>ID</th>
                                <th>Status</th>
                                <th>OS</th>
                                <th>CPU</th>
                                <th>Memory</th>
                            </tr>
                        </thead>
                        <tbody id="ledgerTableBody"></tbody>
                    </table>
                </div>

                <!-- Bottom Pagination -->
                <div class="p-2 border-top bg-light d-flex justify-content-between align-items-center flex-shrink-0">
                    <small class="text-muted ms-2" id="ledgerPageInfo">Page 1</small>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm w-auto" id="ledgerPageSize" onchange="ledgerPage=1; renderLedgerTable()">
                            <option value="20">20 rows</option>
                            <option value="50">50 rows</option>
                            <option value="100">100 rows</option>
                        </select>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-white border" onclick="changeLedgerPage(-1)"><</button>
                            <button class="btn btn-white border" onclick="changeLedgerPage(1)">></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Global Vars
    let remoteWidth = 1920, remoteHeight = 1080;
    let ws = new WebSocket("ws://" + location.host + "/ws/web");
    let curClient = null, screenTimer = null, currentPath = "C:\\", allProcs = [];
    let groups = [];
    let clientDataMap = {}; 
    let allClientsCache = []; 
    let isUploading = false, uploadCancelled = false;
    const CHUNK_SIZE = 1024 * 40; 
    let FILE_THRESHOLD_MB = 10; 
    let runningTasks = {}, currentViewingTaskId = null;
	let isScreenMonitoring = false;
	
    // Modals
    const confirmModal = new bootstrap.Modal(document.getElementById('globalConfirmModal'));
    let confirmCallback = null;
    function showModalConfirm(msg, cb) { document.getElementById('globalConfirmMsg').innerHTML = msg; confirmCallback = cb; confirmModal.show(); }
    document.getElementById('globalConfirmBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); confirmModal.hide(); });
    function showModalAlert(msg) { showToast(msg, 'info'); }

    function showToast(msg, type='success') {
        const bg = type==='success'?'bg-success':(type==='error'?'bg-danger':'bg-primary');
        const toastEl = document.createElement('div'); 
        toastEl.className = `toast align-items-center text-white ${bg} border-0 show shadow`;
        toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.toast').remove()"></button></div>`;
        document.querySelector('.toast-container').appendChild(toastEl);
        setTimeout(() => { if(toastEl.parentNode) toastEl.remove(); }, 3000);
    }

    // WebSocket Logic
    ws.onmessage = (e) => {
        let msg = JSON.parse(e.data);
        if(msg.type === "refresh_list") loadClients();
        if(msg.type === "groups") { groups = msg.payload; updateGroupSelects(); }
        if (msg.type === "download_progress") {
            const pl = msg.payload;
            const taskId = pl.task_id || findTaskIdByPath(msg.client_id, pl.path);
            if(taskId) handleProgressUpdate(taskId, msg.client_id, pl);
        }
		if(msg.client_id !== curClient && msg.type !== "refresh_list" && msg.type !== "sys_info" && msg.type !== "usb_record") return;

        if(msg.type === "cmd_out") {
            let t = document.getElementById("termOutput"); 
			let formatted = msg.payload.replace(/</g,"&lt;").replace(/\n/g, "");
			t.insertAdjacentHTML('beforeend', `<div class="text-break">${formatted}</div>`); 
			
            t.scrollTop = t.scrollHeight;
            if(msg.cwd) { document.getElementById("cmdPrompt").innerText = msg.cwd + ">"; currentPath = msg.cwd; }
        } else if (msg.type === "screen") {
			isRequestingFrame = false;
			
			let now = Date.now();
            let rtt = now - lastReqTime;
            adjustQuality(rtt);
			
			if (!isScreenMonitoring) return; 
            let img = document.getElementById("screenDisplay");
            let ph = document.getElementById("screenPlaceholder");
            let statusBadge = document.getElementById("screenStatus");
			
            statusBadge.innerText = `Monitoring Q:${Math.floor(autoQuality)} S:${autoScale.toFixed(1)} T:${rtt}ms`;

            if (msg.payload && msg.payload.length > 100) {
                statusBadge.innerText = 'Monitoring';
                statusBadge.className = 'badge bg-success d-flex align-items-center';
                document.getElementById("controlToggle").disabled = false; 
                
                if(msg.width) { remoteWidth = msg.width; remoteHeight = msg.height; }
				img.onload = function() {
                    if (isScreenMonitoring) {
                        requestAnimationFrame(() => requestNextFrame());
                    }
                };
				
                img.src = "data:image/jpeg;base64," + msg.payload;
				img.style.display = 'block'; 
                ph.style.display = 'none';
            } else {
                img.style.display = "none";
                ph.style.display = "block"; 
                
                if (msg.payload === "LOCKED") {
                    statusBadge.innerText = 'Desktop locked'; 
                    statusBadge.className = 'badge bg-warning text-dark d-flex align-items-center';
                    ph.innerHTML = '<i class="fas fa-user-lock fs-1 mb-3 text-warning"></i><div>Desktop locked or not logged in</div><div class="small text-muted mt-2">Reverse connection requires active login session</div>';
                } else {
                    statusBadge.innerText = 'No Signal';
                    statusBadge.className = 'badge bg-danger d-flex align-items-center';
                    ph.innerHTML = '<i class="fas fa-exclamation-triangle fs-1 mb-3 text-danger"></i><div>Temporarily unable to get screen</div><div class="small text-muted mt-2">Error code: ' + (msg.payload || 'No Response') + '</div>';
                }
				setTimeout(() => requestNextFrame(), 1000);
            }
        } else if (msg.type === "file_list") {
            if(msg.path) currentPath = msg.path; document.getElementById("filePath").value = currentPath; renderFiles(msg.payload);
        } else if (msg.type === "ps_list") { allProcs = msg.payload; renderPs(allProcs);
        } else if (msg.type === "sys_info") { 
            if (msg.client_id) {
                ledgerCache[msg.client_id] = msg.payload;
                const ledgerModal = document.getElementById('ledgerModal');
                if (ledgerModal && ledgerModal.classList.contains('show')) {
                    renderLedgerTable();
                }
            }

            if (curClient && (msg.client_id === curClient || (clientDataMap[curClient] && clientDataMap[curClient].ip === msg.client_id))) {
                displaySysInfo(msg.payload);
            }
        } else if (msg.type === "drive_list") { renderDrives(msg.payload); }
    };

	function loadDrives() {
        sendReq("fs_drives", "");
    }
	
	function renderDrives(drives) {
        const container = document.getElementById("driveListContainer");
        if(!drives || !drives.length) return;
        
        container.innerHTML = drives.map(d => {
            let pathArg = d;
            if (d.includes(":")) { 
                 pathArg = d + "\\\\";
            } else {
                 pathArg = d; 
            }
            
            return `<a class="tree-link" onclick="forceCd('${pathArg}')">
                        <i class="fas fa-hdd text-secondary"></i> Local Disk (${d})
                    </a>`;
        }).join('');
    }

    function renderDefaultDrives() {
        document.getElementById("driveListContainer").innerHTML = `
            <a class="tree-link" onclick="forceCd('C:\\\\')"><i class="fas fa-hdd text-secondary"></i> Local Disk (C:)</a>
            <a class="tree-link" onclick="forceCd('D:\\\\')"><i class="fas fa-hdd text-secondary"></i> Local Disk (D:)</a>
        `;
    }

	let isRequestingFrame = false;

    function toggleScreen(on) {
        isScreenMonitoring = on;
        if(screenTimer) { clearInterval(screenTimer); screenTimer = null; }

        let img = document.getElementById("screenDisplay");
        let ph = document.getElementById("screenPlaceholder");

        if(on) { 
            img.style.display = "none";
            ph.style.display = "block";
            ph.innerHTML = '<div class="spinner-border text-primary" role="status"></div><div class="mt-2 text-muted">Requesting screen data...</div>';
            
			requestNextFrame(); 
        } else {
            document.getElementById("screenStatus").innerText="Stopped"; 
            document.getElementById("screenStatus").className="badge bg-secondary d-flex align-items-center";
            document.getElementById("controlToggle").disabled=true; 
            document.getElementById("controlToggle").checked=false;
            
            if (!img.src || img.src.length < 100) {
                ph.style.display = "block";
                ph.innerHTML = '<i class="fas fa-desktop fs-1 mb-3 opacity-25"></i><div>Click Start to Monitor</div>';
            }
        }
    }
	
    let lastReqTime = 0; 
    let autoQuality = 80;  
    let autoScale = 0.6;  
    let frameCount = 0;
    let rttSum = 0;

    function requestNextFrame() {
        if (!isScreenMonitoring) return;
        if (isRequestingFrame) return;

        isRequestingFrame = true;
        lastReqTime = Date.now();

        const selectEl = document.getElementById("qualitySelect");
        const mode = selectEl ? selectEl.value : 'high'; 
        
        let q, s;

        switch(mode) {
            case 'auto':   q = Math.floor(autoQuality); s = autoScale.toFixed(2); break;
            case 'low':    q = 30; s = 0.5; break;
            case 'medium': q = 50; s = 0.8; break;
            case 'high':   q = 80; s = 1.0; break; 
            case 'ultra':  q = 95; s = 1.0; break;
            default:       q = 80; s = 1.0; 
        }

        sendReq("screen_req", `${q}|${s}`); 
    }
	
    const screenImg = document.getElementById("screenDisplay"), sc = document.getElementById("screenContainer");
    document.getElementById("controlToggle").addEventListener('change', e=>{ screenImg.style.cursor = e.target.checked ? "crosshair" : "default"; if(e.target.checked) sc.focus(); });
    screenImg.addEventListener("mousedown", e=>handleMouse(e, "down")); window.addEventListener("mouseup", e => {
        if (document.getElementById("controlToggle").checked) {
            handleMouse(e, "up");
        }
    });
    screenImg.addEventListener("mousemove", e=>{ if(document.getElementById("controlToggle").checked && Math.random()<0.4) sendInput("mouse_move", getCoords(e)); });
	screenImg.addEventListener("contextmenu", e => e.preventDefault());
    sc.addEventListener("contextmenu", e => e.preventDefault());
	screenImg.addEventListener("wheel", e => {
        // Send only when control is enabled
        if (!document.getElementById("controlToggle").checked) return;
        
        e.preventDefault();

        sendInput("mouse_wheel", { delta: e.deltaY });
    }, { passive: false }); 
    sc.addEventListener("keydown", e=>{ if(document.getElementById("controlToggle").checked) { e.preventDefault(); sendInput("key", {key:e.keyCode, state:"down"}); } });
    sc.addEventListener("keyup", e=>{ if(document.getElementById("controlToggle").checked) { e.preventDefault(); sendInput("key", {key:e.keyCode, state:"up"}); } });
    function handleMouse(e, s) { if(!document.getElementById("controlToggle").checked) return; e.preventDefault(); let b=e.button===2?"right":(e.button===1?"middle":"left"); let c=getCoords(e); sendInput("mouse_click", {button:b, state:s, x:c.x, y:c.y}); }
    function getCoords(e) { 
        let r = screenImg.getBoundingClientRect(); 
        
        let x = (e.clientX - r.left) * (remoteWidth / r.width);
        let y = (e.clientY - r.top) * (remoteHeight / r.height);

        return {x: x, y: y}; 
    }
    function sendInput(t, d) { d.event=t; sendReq("input_event", d); }


    // Logic
    function sendCmd() { let i=document.getElementById("cmdInput"); sendReq("cmd", i.value); i.value=""; }
    function refreshPs() { sendReq("ps_list",""); }
    function renderPs(l) { document.getElementById("psTableBody").innerHTML = l.map(p=>`<tr><td class="ps-3 font-monospace">${p.pid}</td><td>${p.name}</td><td>${(p.mem/1024/1024).toFixed(1)}</td><td class="text-end pe-3"><button class="btn btn-sm btn-light border-0 text-danger" onclick="showModalConfirm('Terminate ${p.pid}?',()=>sendReq('ps_kill',${p.pid}))"><i class="fas fa-times"></i></button></td></tr>`).join(''); }
    function filterPs(v) { renderPs(allProcs.filter(p=>p.name.toLowerCase().includes(v.toLowerCase()))); }
    function refreshFiles() { sendReq("fs_list", currentPath); }
    function forceCd(p) { currentPath=p; refreshFiles(); }
    function cdToPath() { currentPath=document.getElementById("filePath").value; refreshFiles(); }
    function goUp() {

		let p = currentPath.replace(/\//g, "\\");
		
		if (/^[a-zA-Z]:\\?$/.test(p)) return;

		if (p.endsWith("\\")) p = p.slice(0, -1);

		let i = p.lastIndexOf("\\");
		if (i > 0) {
			currentPath = p.substring(0, i);
			if (currentPath.endsWith(":")) currentPath += "\\";
		} else {
			if (/^[a-zA-Z]:/.test(p)) {
				 currentPath = p.substring(0, 2) + "\\";
			}
		}
		refreshFiles();
	}
    function renderFiles(l) {
        if(!l||!l.length) return document.getElementById("fileTableBody").innerHTML='<tr><td colspan="3" class="text-center text-muted py-3">Empty directory</td></tr>';
        document.getElementById("fileTableBody").innerHTML = l.map(f=>{
            let p = currentPath + (currentPath.endsWith("\\")?"":"\\") + f.name, ep = p.replace(/\\/g,"\\\\");
            let icon = f.is_dir ? '<i class="fas fa-folder text-warning"></i>' : '<i class="far fa-file text-secondary"></i>';
            let nameClick = f.is_dir ? `onclick="currentPath='${ep}';refreshFiles()"` : '';
            let cursorStyle = f.is_dir ? 'cursor:pointer' : '';
            
            let act = f.is_dir ? 
                `<button class="btn btn-sm btn-light border-0" onclick="currentPath='${ep}';refreshFiles()"><i class="fas fa-chevron-right"></i></button>` : 
                `<div class="d-flex justify-content-end gap-1">
                    <button class="btn btn-sm btn-light border-0 text-success" title="Run" onclick="showModalConfirm('Run?',()=>sendReq('file_exec','${ep}'))"><i class="fas fa-play"></i></button>
                    <button class="btn btn-sm btn-light border-0 text-primary" title="Download" onclick="window.open('/api/file/download?client_id=${curClient}&path='+encodeURIComponent('${ep}'))"><i class="fas fa-download"></i></button>
                    <button class="btn btn-sm btn-light border-0 text-danger" title="Delete" onclick="showModalConfirm('Delete?',()=>{ sendReq('file_delete','${ep}'); setTimeout(refreshFiles, 500); })"><i class="fas fa-trash"></i></button>
                 </div>`;
            return `<tr>
                        <td class="ps-3" ${nameClick} style="${cursorStyle}">${icon} <span class="ms-2 user-select-none">${f.name}</span></td>
                        <td class="small text-muted">${f.is_dir?'':(f.size/1024).toFixed(1)+'KB'}</td>
                        <td class="text-end pe-3 file-actions-cell">${act}</td>
                    </tr>`;
        }).join('');
    }

    // Upload & Batch
    async function doUpload() {
        const file = document.getElementById("upFile").files[0]; if(!file||!curClient)return;
        const th = (parseInt(document.getElementById('batchFileThreshold').value)||10)*1024*1024;
        document.getElementById("upFile").value="";
        if(file.size>th) handleLargeFileUpload([curClient], {file, remotePath: currentPath, run:false, runAsAdmin:false});
        else handleSmallFileUpload_Single(file);
    }
    
	async function moveClient(id, direction) {
        // Get target client info
        let client = clientDataMap[id];
        if (!client) return;
        
        // Determine group...
        let groupName = client.group || "Default Group"; 
        // Filter again to be safe
        let groupClients = allClientsCache.filter(c => (c.group || "Default Group") === groupName);

        // Find current client index...
        let currentIndex = groupClients.findIndex(c => (c.id || c.ip) === id);
        if (currentIndex === -1) return;

        // Calc target index
        let newIndex = currentIndex + direction;
        if (newIndex < 0 || newIndex >= groupClients.length) return; // Out of bounds check

        // Swap in temp array
        let temp = groupClients[currentIndex];
        groupClients[currentIndex] = groupClients[newIndex];
        groupClients[newIndex] = temp;

        // Regenerate sort weights
        // Simple strategy: interval of 10
        let updates = groupClients.map((c, index) => ({
            id: c.id || c.ip,
            sort_order: (index + 1) * 10
        }));

        // Send to server
        try {
            await fetch("/api/client/reorder", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({updates: updates})
            });
        } catch (e) {
            showToast("Sort failed", "error");
        }
    }
	
    async function handleSmallFileUpload_Single(file) {
        const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
        document.getElementById('uploadFileName').innerText = file.name;
        document.getElementById('uploadProgressBar').style.width = "0%";
        document.getElementById('uploadPercent').innerText = "0%";
        isUploading=true; uploadCancelled=false; modal.show();
        try {
            let dir = currentPath.trim(); if(!dir) dir="C:\\"; if(/^[a-zA-Z]:$/.test(dir)) dir+="\\"; if(!dir.endsWith("\\") && !dir.endsWith("/")) dir+="\\";
            let fullPath = dir+file.name;
            ws.send(JSON.stringify({type:"forward_to_agent", target_id: curClient, payload: {type: "upload_start", file_path: fullPath, total_size: file.size}}));
            let offset=0;
            while(offset<file.size) {
                if(uploadCancelled) throw new Error("Cancelled");
                const b64 = await fileToBs64(file.slice(offset, offset+CHUNK_SIZE));
                ws.send(JSON.stringify({type:"forward_to_agent", target_id: curClient, payload: {type: "upload_chunk", data: b64}}));
                offset+=CHUNK_SIZE;
                let pct=Math.min(100, Math.round((offset/file.size)*100));
                document.getElementById('uploadProgressBar').style.width=pct+"%";
                document.getElementById('uploadPercent').innerText=pct+"%";
                document.getElementById('uploadSizeInfo').innerText = `${(offset/1024/1024).toFixed(1)}/${(file.size/1024/1024).toFixed(1)}MB`;
                await new Promise(r=>setTimeout(r,5));
            }
            ws.send(JSON.stringify({type:"forward_to_agent", target_id: curClient, payload: {type: "upload_finish"}}));
            showToast("Upload successful"); setTimeout(refreshFiles, 1000); setTimeout(()=>modal.hide(),500);
        } catch(e) { showToast("Failed","error"); modal.hide(); } finally { isUploading=false; }
    }

    function cancelUpload() { if(isUploading) uploadCancelled=true; }
    
     async function handleLargeFileUpload(targets, config) {
        const taskId = "task_" + Date.now(), file = config.file;
        runningTasks[taskId] = { id: taskId, fileName: file.name, targets: targets, targetData: {}, stage: 'uploading', serverUrl: '', config: config, uploadPercent: 0 };
        
        let dir = (config.remotePath || "").trim(); if(!dir) dir = "C:\\Temp"; if(/^[a-zA-Z]:$/.test(dir)) dir += "\\"; if(!dir.endsWith("\\") && !dir.endsWith("/")) dir += "\\";
        let finalPath = dir + file.name;
        targets.forEach(tid => { runningTasks[taskId].targetData[tid] = { percent: 0, status: 'waiting', path: finalPath }; });

        showLargeFileModal(taskId); updateTaskCenterUI();

        try {
            const formData = new FormData(); formData.append("file", file);
            const xhr = new XMLHttpRequest(); xhr.open("POST", "/api/file/stage");
            xhr.upload.onprogress = (e) => { if(e.lengthComputable) { let pct = Math.round((e.loaded/e.total)*100); runningTasks[taskId].uploadPercent = pct; if(currentViewingTaskId===taskId) document.getElementById('serverUploadBar').style.width=pct+'%'; } };
            const serverUrl = await new Promise((res, rej) => { xhr.onload = () => xhr.status===200 ? res(JSON.parse(xhr.responseText).url) : rej(xhr.statusText); xhr.onerror = () => rej("Network Error"); xhr.send(formData); });

            runningTasks[taskId].stage = 'pulling'; runningTasks[taskId].serverUrl = serverUrl;
            let fullUrl = window.location.origin + serverUrl;
            if(currentViewingTaskId === taskId) { document.getElementById('stageUploadSection').style.display='none'; document.getElementById('clientPullSection').style.display='block'; renderTaskRows(taskId); }
            updateTaskCenterUI();

            targets.forEach(tid => {
                ws.send(JSON.stringify({ type: "forward_to_agent", target_id: tid, payload: { type: "file_pull", payload: { url: fullUrl, path: runningTasks[taskId].targetData[tid].path, run: config.run, run_as_admin: config.runAsAdmin, task_id: taskId } } }));
                runningTasks[taskId].targetData[tid].status = 'sent'; 
                if(currentViewingTaskId === taskId) updateSingleRowUI(taskId, tid);
            });
        } catch (e) { showToast("Error: "+e, "error"); delete runningTasks[taskId]; updateTaskCenterUI(); }
    }

    function showLargeFileModal(taskId) {
        const task = runningTasks[taskId]; if(!task) return; currentViewingTaskId = taskId;
        let isAllDone = false; if (task.stage === 'pulling') isAllDone = task.targets.every(tid => ['finished', 'error', 'cancelled'].includes(task.targetData[tid].status));
        const m = new bootstrap.Modal(document.getElementById('largeFileModal'));
        const btnHide = document.getElementById('btnHideTask'), btnCancel = document.getElementById('btnCancelTask');
        if (isAllDone) {
            btnHide.innerHTML = 'Close'; btnHide.className = 'btn btn-success btn-sm'; btnHide.removeAttribute('data-bs-dismiss');
            btnHide.onclick = function() { bootstrap.Modal.getInstance(document.getElementById('largeFileModal')).hide(); delete runningTasks[taskId]; updateTaskCenterUI(); };
            btnCancel.disabled = true;
        } else {
            btnHide.innerHTML = 'Hide'; btnHide.className = 'btn btn-primary btn-sm'; btnHide.setAttribute('data-bs-dismiss', 'modal'); btnHide.onclick = null; btnCancel.disabled = false;
        }
        if(task.stage === 'uploading') { document.getElementById('stageUploadSection').style.display='block'; document.getElementById('clientPullSection').style.display='none'; document.getElementById('serverUploadBar').style.width=task.uploadPercent+'%'; } 
        else { document.getElementById('stageUploadSection').style.display='none'; document.getElementById('clientPullSection').style.display='block'; renderTaskRows(taskId); }
        m.show();
    }
    
    function renderTaskRows(taskId) {
        const task = runningTasks[taskId]; document.getElementById('largeFileTableBody').innerHTML = task.targets.map(tid => {
            let c = clientDataMap[tid];
            return `<tr><td class="ps-3"><div class="fw-bold">${c?.alias||tid}</div><div class="small text-muted font-monospace">${c?.ip}</div></td>
            <td><div class="progress" style="height:6px"><div id="task_bar_${tid}" class="progress-bar" style="width:0%"></div></div></td>
            <td><span id="task_status_${tid}" class="badge bg-secondary">Wait</span></td>
            <td><button class="btn btn-sm btn-link text-danger p-0" onclick="cancelSinglePull('${taskId}','${tid}')">x</button></td></tr>`;
        }).join('');
        task.targets.forEach(tid => updateSingleRowUI(taskId, tid));
    }
    function updateSingleRowUI(taskId, tid) {
        const d = runningTasks[taskId].targetData[tid], b = document.getElementById(`task_bar_${tid}`), s = document.getElementById(`task_status_${tid}`);
        if(!b||!s)return; b.style.width = d.percent + '%';
        if(d.status==='downloading') { s.className="badge bg-primary"; s.innerText=d.percent+'%'; } 
        else if(d.status==='finished') { b.className="progress-bar bg-success"; s.className="badge bg-success"; s.innerText="Finished"; }
        else if(d.status==='error'||d.status==='cancelled') { b.className="progress-bar bg-danger"; s.className="badge bg-danger"; s.innerText="Failed"; }
        else { s.className="badge bg-info text-dark"; s.innerText="Requesting..."; }
    }
    function updateTaskCenterUI() {
        const ids = Object.keys(runningTasks), lst = document.getElementById('ongoingTaskList');
        document.getElementById('globalTaskCount').innerText = ids.length; document.getElementById('globalTaskCount').style.display = ids.length?'block':'none';
        if(!ids.length) return lst.innerHTML='<div class="p-3 text-center text-muted small">No background tasks</div>';
        lst.innerHTML = ids.map(id => {
            const t = runningTasks[id];
            return `<div class="p-2 border-bottom bg-white cursor-pointer" onclick="showLargeFileModal('${id}')"><div class="d-flex justify-content-between mb-1"><span class="small fw-bold text-truncate" style="max-width:180px">${t.fileName}</span><span class="badge bg-light text-dark border">${t.stage==='uploading'?'Upload':'Distribute'}</span></div><div class="progress" style="height:4px"><div class="progress-bar" style="width:${t.stage==='uploading'?t.uploadPercent:50}%"></div></div></div>`;
        }).join('');
    }
    function cancelSinglePull(taskId, cid) { const t = runningTasks[taskId]; if(t) ws.send(JSON.stringify({type:"forward_to_agent", target_id: cid, payload: {type:"cancel_pull", payload: t.targetData[cid].path}})); }
    function cancelAllLargeFile() { if(currentViewingTaskId && runningTasks[currentViewingTaskId]) { const t = runningTasks[currentViewingTaskId]; t.targets.forEach(cid => cancelSinglePull(currentViewingTaskId, cid)); bootstrap.Modal.getInstance(document.getElementById('largeFileModal')).hide(); } }
    function findTaskIdByPath(cid, p) { for(let id in runningTasks) if(runningTasks[id].targetData[cid]?.path === p) return id; return null; }
    function handleProgressUpdate(taskId, cid, data) {
         const t = runningTasks[taskId]; if(t && t.targetData[cid]) { t.targetData[cid] = {...t.targetData[cid], ...data}; if(currentViewingTaskId===taskId) updateSingleRowUI(taskId, cid); if(['finished','error','cancelled'].includes(data.status)) { updateTaskCenterUI(); if(t.stage==='pulling' && t.targets.every(x=>['finished','error','cancelled'].includes(t.targetData[x].status))) setTimeout(()=>{ if(currentViewingTaskId===taskId) { bootstrap.Modal.getInstance(document.getElementById('largeFileModal')).hide(); showToast("Task finished"); } delete runningTasks[taskId]; updateTaskCenterUI(); }, 1500); } }
    }


    // Batch UI Fix
    function addBatchCommand() { 
		document.getElementById("batchCmdEmpty").style.display="none"; 
		let id=Date.now(); 
		document.getElementById("batchCommandList").insertAdjacentHTML('beforeend', 
			`<div class="input-group mb-2 batch-item-cmd" id="cmd_${id}">
				<span class="input-group-text bg-white border-end-0">>_</span>
				<input type="text" class="form-control border-start-0" placeholder="Enter command..." id="cmd_input_${id}">
				<button class="btn btn-white border text-danger" onclick="removeBatchItem('cmd_${id}', 'cmd')"><i class="fas fa-times"></i></button>
			</div>`
		); 
	}
    function addBatchFile() { 
		document.getElementById("batchFileEmpty").style.display="none"; 
		let id=Date.now(); 
		document.getElementById("batchFileList").insertAdjacentHTML('beforeend', 
			`<div class="border rounded p-3 mb-2 bg-white batch-item-file position-relative" id="file_${id}">
				<button class="btn btn-sm text-danger position-absolute top-0 end-0 m-1" onclick="removeBatchItem('file_${id}', 'file')"><i class="fas fa-times"></i></button>
				<div class="mb-2 pe-3"><input type="file" class="form-control form-control-sm" id="file_input_${id}"></div>
				<input type="text" class="form-control form-control-sm mb-2" placeholder="Target path (e.g. C:\\Temp)" id="file_path_${id}">
				<div class="d-flex gap-3 small">
					<div class="form-check"><input type="checkbox" class="form-check-input" id="file_overwrite_${id}" checked><label class="form-check-label">Force overwrite</label></div>
					<div class="form-check"><input type="checkbox" class="form-check-input" id="file_run_${id}"><label class="form-check-label">Run after finish</label></div>
					<div class="form-check"><input type="checkbox" class="form-check-input" id="file_admin_${id}"><label class="form-check-label">Run as Admin</label></div>
				</div>
			</div>`
		); 
	}
	
	function removeBatchItem(elementId, type) {
		// Remove element
		const el = document.getElementById(elementId);
		if(el) el.remove();

		// Check if empty, show hint if so
		if (type === 'cmd') {
			const count = document.querySelectorAll('.batch-item-cmd').length;
			if (count === 0) document.getElementById("batchCmdEmpty").style.display = "flex"; // flex for centering
		} else if (type === 'file') {
			const count = document.querySelectorAll('.batch-item-file').length;
			if (count === 0) document.getElementById("batchFileEmpty").style.display = "flex";
		}
	}
    
    async function executeBatchTask() {
        const targets = getSelectedIPs().filter(ip => clientDataMap[ip]?.is_online);
        if(!targets.length) return showModalAlert("Please select online hosts");
        const cmds = Array.from(document.querySelectorAll('[id^="cmd_input_"]')).map(i=>i.value.trim()).filter(v=>v);
        const files = []; Array.from(document.querySelectorAll('[id^="file_input_"]')).forEach(i=>{ if(i.files.length) { let id=i.id.replace('file_input_',''); files.push({file:i.files[0], remotePath:document.getElementById(`file_path_${id}`).value, overwrite:document.getElementById(`file_overwrite_${id}`).checked, run:document.getElementById(`file_run_${id}`).checked, runAsAdmin:document.getElementById(`file_admin_${id}`).checked}); } });
        if(!cmds.length && !files.length) return showModalAlert("Task is empty");
        showModalConfirm(`Execute on ${targets.length} hosts?`, async ()=>{
            if(cmds.length) { await fetch("/api/batch/execute", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({targets, commands:cmds.map(c=>({command:c})), files:[]})}); showToast("Command dispatched"); }
            if(files.length) startBatchUpload(targets, files);
        });
    }
    function startBatchUpload(targets, files) {
        const th = (parseInt(document.getElementById('batchFileThreshold').value)||10)*1024*1024;
        let large = files.find(f=>f.file.size>th);
        if(large) { if(files.length>1) showToast("Large files only support single transfer","warning"); handleLargeFileUpload(targets, large); } else { handleSmallFileUpload(targets, files); }
    }

     async function handleSmallFileUpload(targets, files) {
        const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
        document.getElementById('uploadProgressBar').style.width = "0%";
        isUploading = true; uploadCancelled = false; modal.show();
        try {
            for(let i=0; i<files.length; i++) {
                if(uploadCancelled) throw new Error("Cancelled");
                let f = files[i], dir = (f.remotePath||"").trim() || "C:\\Temp"; if(/^[a-zA-Z]:$/.test(dir)) dir+="\\"; if(!dir.endsWith("\\") && !dir.endsWith("/")) dir+="\\"; let fullPath = dir + f.file.name;
                document.getElementById('uploadFileName').innerText = `[${i+1}/${files.length}] ${f.file.name}`;
                ws.send(JSON.stringify({type:"forward_batch", targets, payload:{type:"upload_start", file_path: fullPath, total_size:f.file.size, overwrite:f.overwrite}}));
                let offset=0;
                while(offset < f.file.size) {
                    if(uploadCancelled) throw new Error("Cancelled");
                    const chunk = await fileToBs64(f.file.slice(offset, offset+CHUNK_SIZE));
                    ws.send(JSON.stringify({type:"forward_batch", targets, payload:{type:"upload_chunk", data:chunk}}));
                    offset += CHUNK_SIZE;
                    let pct = Math.min(100, Math.round((offset/f.file.size)*100));
                    document.getElementById('uploadProgressBar').style.width = pct+"%"; document.getElementById('uploadPercent').innerText = pct+"%";
                    await new Promise(r=>setTimeout(r, 5));
                }
                ws.send(JSON.stringify({type:"forward_batch", targets, payload:{type:"upload_finish", run:f.run, run_as_admin:f.runAsAdmin}}));
                await new Promise(r=>setTimeout(r, 100));
            }
            setTimeout(() => { modal.hide(); showToast(`Finished`); }, 500);
        } catch(e) { showToast("Error", "error"); modal.hide(); } finally { isUploading = false; }
    }


    // Helpers
    function sendReq(t,p) { if(curClient) fetch("/api/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target_id:curClient,type:t,payload:p})}); }
    function loadSysInfo() { sendReq("sys_info", ""); }
    function displaySysInfo(i) { ['cpu','mem','disk','net','os','time'].forEach(k=>document.getElementById(k+'Info').innerText = i[k==='mem'?'memory':(k==='net'?'network':k)]||"N/A"); }
    function execFunction(fn) { showModalConfirm('Confirm execution?', ()=>sendReq("function", fn)); }
    function fileToBs64(b) { return new Promise((r,j)=>{ let rd=new FileReader(); rd.onload=()=>r(rd.result.split(',')[1]); rd.onerror=j; rd.readAsDataURL(b); }); }
    async function loadClients(btnElement) { 
        let icon;
        // Safety check
        if(btnElement && btnElement instanceof Element) {
            icon = btnElement.querySelector('i');
            if(icon) icon.classList.add('fa-spin');
        }

        try { 
            let r = await fetch("/api/clients?t=" + Date.now()); 
            let data = await r.json(); 
            
            allClientsCache = data || []; 
            
            clientDataMap = {}; 
            allClientsCache.forEach(c => clientDataMap[c.id || c.ip] = c); 
            
            let countLabel = document.getElementById('totalClientCount');
            if(countLabel) countLabel.innerText = `${allClientsCache.length} Hosts`; 
            
            if (curClient && clientDataMap[curClient]) { 
                let c = clientDataMap[curClient]; 
                let btnMonitor = document.getElementById("btnStartMonitor");
                if(btnMonitor) btnMonitor.disabled = !c.is_online; 
            } else if (allClientsCache.length === 0) {
                let btnMonitor = document.getElementById("btnStartMonitor");
                if(btnMonitor) btnMonitor.disabled = true;
            }
            
            let searchInput = document.getElementById('clientSearchInput');
            filterClients(searchInput ? searchInput.value : ""); 
            
        } catch(e) {
            console.error("Load clients failed:", e);
            showToast("Refresh failed: " + e.message, "error");
        } finally {
            if(icon) setTimeout(() => icon.classList.remove('fa-spin'), 500);
        }
    }

	function filterClients(t) {
		let searchText = (t !== undefined ? t : document.getElementById('clientSearchInput').value).toLowerCase();
		let statusFilter = document.getElementById('clientStatusFilter') ? document.getElementById('clientStatusFilter').value : 'all';
		let filtered = allClientsCache.filter(c => {
			let matchText = c.ip.toLowerCase().includes(searchText) || (c.alias || "").toLowerCase().includes(searchText);
			
			let matchStatus = true;
			if (statusFilter === 'online') matchStatus = c.is_online;
			if (statusFilter === 'offline') matchStatus = !c.is_online;

			return matchText && matchStatus;
		});
		
		renderClientList(filtered);
	}
    
    function renderClientList(clients) {
        const container = document.getElementById("clientListArea");
        
        let clientMap = {}; 
        let rootClients = [];
        
        (clients || []).forEach(c => {
            let gid = c.group_id || ""; 
            if (!gid && c.group) {
                let found = groupsRaw.find(g => g.name === c.group);
                if (found) gid = found.id;
            }

            if (!gid) {
                rootClients.push(c);
            } else {
                if (!clientMap[gid]) clientMap[gid] = [];
                clientMap[gid].push(c);
            }
        });

        let html = "";
        
        function countNestedClients(g) {
            let c = 0;
            if(g.children) g.children.forEach(child => {
                c += (clientMap[child.id] || []).length;
                c += countNestedClients(child);
            });
            return c;
        }

        function renderTreeNodes(nodeList) {
            let s = "";
            nodeList.forEach(group => {
                let groupClients = clientMap[group.id] || [];
                let totalCount = groupClients.length + countNestedClients(group);
                let isCollapsed = localStorage.getItem(`grp_collapse_${group.id}`) === 'true';
                
                let iconClass = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down';
                let dimIcon = (group.children.length === 0 && groupClients.length === 0) ? 'opacity-25' : '';

                s += `<div class="group-node" id="gnode_${group.id}">
                        <div class="group-header" onclick="toggleGroupNode('${group.id}')">
                             <i class="fas ${iconClass} me-2 text-secondary ${dimIcon}" style="font-size:0.7em; width:10px;"></i>
                             <input type="checkbox" class="form-check-input group-checkbox me-2 p-0" 
                                    style="width: 1.1em; height: 1.1em;"
                                    data-target="gchild_${group.id}" 
                                    onclick="event.stopPropagation(); toggleGroup(this)">
                             <span class="fw-bold text-secondary">${group.name}</span>
                             <span class="ms-2 badge bg-secondary opacity-25 rounded-pill" style="font-size:0.6rem">${totalCount}</span>
                             
                             <div class="group-actions" onclick="event.stopPropagation()">
                                <div class="group-menu-trigger me-1" onclick="openGroupModal('add', '${group.id}', '', event)" title="Add sub-group">
                                    <i class="fas fa-plus text-success"></i>
                                </div>
                                <div class="dropdown d-inline-block">
                                    <div class="group-menu-trigger" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v text-muted"></i>
                                    </div>
                                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-sm">
                                        <li><a class="dropdown-item" onclick="moveGroup('${group.id}', -1)">Move Up</a></li>
                                        <li><a class="dropdown-item" onclick="moveGroup('${group.id}', 1)">Move Down</a></li>
                                        <li><a class="dropdown-item" onclick="openGroupModal('rename', '${group.id}', '${group.name}')">Rename</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" onclick="confirmDeleteGroup('${group.id}')">Delete</a></li>
                                    </ul>
                                </div>
                             </div>
                        </div>
                        <div class="group-children ${isCollapsed ? 'collapsed' : ''}" id="gchild_${group.id}">
                            ${renderClients(groupClients)}
                            ${renderTreeNodes(group.children)}
                        </div>
                      </div>`;
            });
            return s;
        }

        // Generate client list items HTML
        function renderClients(list) {
            if (!list || list.length === 0) return ""; 
            
            let s = "";
            let sel = new Set(); 
            document.querySelectorAll('.client-checkbox:checked').forEach(c => sel.add(c.value));
            
            list.forEach(c => {
                let id = c.id || c.ip;
                let displayIp = `${c.ip}`;
                let passiveBadge = c.mode === 'passive' ? '<i class="fas fa-satellite-dish ms-1 text-muted small" title="Reverse"></i>' : '';
                
                s += `<div class="client-item ${id===curClient?'active':''}" onclick="sel('${id}','${c.alias||c.ip}',${c.is_online})">
                        <input type="checkbox" class="form-check-input me-3 client-checkbox" value="${id}" ${sel.has(id)?"checked":""} onclick="event.stopPropagation();updateBatchUI()">
                        <div class="client-info-row">
                             <div class="d-flex align-items-center">
                                 <span class="status-dot ${c.is_online?(c.mode==='passive'?'online-passive':'online'):'offline'}"></span>
                                 <span class="client-name">${c.alias||c.ip}</span> ${passiveBadge}
                             </div>
                             <span class="client-ip-id text-truncate">${displayIp}</span>
                        </div>
                        <div class="dropdown client-menu-btn" data-bs-toggle="dropdown" onclick="event.stopPropagation()">
                             <i class="fas fa-ellipsis-h"></i>
                             <ul class="dropdown-menu dropdown-menu-end dropdown-menu-sm">
                                <li><a class="dropdown-item" onclick="moveClient('${id}', -1)">Move Up</a></li>
                                <li><a class="dropdown-item" onclick="moveClient('${id}', 1)">Move Down</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" onclick="editClient('${id}','${c.alias||''}','${c.group_id||''}','${c.password}', '${c.mode}')">Edit</a></li>
                                <li><a class="dropdown-item text-danger" onclick="removeClient('${id}')">Delete</a></li>
                             </ul>
                        </div>
                    </div>`;
            });
            return s;
        }
        
        let isCollapsed = localStorage.getItem('grp_collapse_root_virtual') === 'true';
        let count = rootClients.length;
        
        html += `<div class="group-node root-virtual" id="gnode_root_virtual">
                    <div class="group-header" onclick="toggleGroupNode('root_virtual')">
                        <i class="fas fa-chevron-${isCollapsed ? 'right' : 'down'} me-2 text-secondary" style="font-size:0.7em; width:10px;"></i>
                        <input type="checkbox" class="form-check-input group-checkbox me-2 p-0"
                               style="width: 1.1em; height: 1.1em;"
                               data-target="gchild_root_virtual"
                               onclick="event.stopPropagation(); toggleGroup(this)">
                        <span class="fw-bold text-secondary">Default Group</span>
                        <span class="ms-2 badge bg-secondary opacity-25 rounded-pill" style="font-size:0.6rem">${count}</span>
                    </div>
                    <div class="group-children ${isCollapsed ? 'collapsed' : ''}" id="gchild_root_virtual">
                        ${rootClients.length > 0 ? renderClients(rootClients) : '<!--div class="text-muted small ps-5 py-2 fst-italic" style="font-size:0.8rem">No default hosts</div-->'}
                    </div>
                 </div>`;

        html += `<div class="group-header bg-light border-bottom border-light">
                    <span class="fw-bold small text-secondary">Group List</span>
                    <div class="group-menu-trigger ms-auto" onclick="openGroupModal('add', '', '', event)" title="Add root group">
                        <i class="fas fa-plus text-success"></i>
                    </div>
                 </div>`;
                 
        if (groupsTree.length === 0) {
             html += '<div class="text-center text-muted small py-3">No groups</div>';
        } else {
             html += renderTreeNodes(groupsTree);
        }

        container.innerHTML = html;
        updateBatchUI();
    }
    
	function toggleGroupNode(gid) {
		const el = document.getElementById(`gchild_${gid}`);
		const icon = document.querySelector(`#gnode_${gid} > .group-header > .fa-chevron-right, #gnode_${gid} > .group-header > .fa-chevron-down`);
		
		if (el) {
			if (el.classList.contains('collapsed')) {
				el.classList.remove('collapsed');
				if(icon) { icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-down'); }
				localStorage.setItem(`grp_collapse_${gid}`, 'false');
			} else {
				el.classList.add('collapsed');
				if(icon) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-right'); }
				localStorage.setItem(`grp_collapse_${gid}`, 'true');
			}
		}
	}

	async function promptAddGroup(parentId) {
		let name = prompt("Enter group name:");
		if (name) {
			await fetch("/api/group/add", {
				method: "POST", headers: {"Content-Type":"application/json"},
				body: JSON.stringify({ name: name, parent_id: parentId || "" })
			});
			loadGroups();
		}
	}

	async function promptRenameGroup(id, oldName) {
		let name = prompt("Rename group:", oldName);
		if (name && name !== oldName) {
			await fetch("/api/group/update", {
				method: "POST", headers: {"Content-Type":"application/json"},
				body: JSON.stringify({ id: id, name: name })
			});
			loadGroups();
		}
	}

	async function moveGroup(id, dir) {
		let group = groupsRaw.find(g => g.id === id);
		if (!group) return;
		
		let siblings = groupsRaw.filter(g => g.parent_id === group.parent_id);
		siblings.sort((a,b) => a.sort_order - b.sort_order); 
		
		let idx = siblings.findIndex(g => g.id === id);
		let targetIdx = idx + dir;
		
		if (targetIdx < 0 || targetIdx >= siblings.length) return;
		
		let other = siblings[targetIdx];
		
		let temp = group.sort_order;
		group.sort_order = other.sort_order;
		other.sort_order = temp;
		
		if (group.sort_order === other.sort_order) {
			group.sort_order += dir;
		}

		await Promise.all([
			fetch("/api/group/update", { method: "POST", body: JSON.stringify({ id: group.id, sort_order: group.sort_order }) }),
			fetch("/api/group/update", { method: "POST", body: JSON.stringify({ id: other.id, sort_order: other.sort_order }) })
		]);
		
		loadGroups();
	}
	
    function toggleGroupDisplay(gid) { let el=document.getElementById(gid); el.style.display = el.style.display==='none'?'block':'none'; }
	
	
	let isAllGroupsCollapsed = false;
    function toggleAllGroups() {
		const allChildren = document.querySelectorAll('.group-children');
		if (allChildren.length === 0) return;

		const isAnyExpanded = Array.from(allChildren).some(el => !el.classList.contains('collapsed'));

		const shouldCollapse = isAnyExpanded;

		allChildren.forEach(el => {
			const gid = el.id.replace('gchild_', '');
			const node = document.getElementById(`gnode_${gid}`);
			const icon = node ? node.querySelector('.group-header .fas.fa-chevron-down, .group-header .fas.fa-chevron-right') : null;

			if (shouldCollapse) {
				el.classList.add('collapsed');
				if (icon) {
					icon.classList.remove('fa-chevron-down');
					icon.classList.add('fa-chevron-right');
				}
				localStorage.setItem(`grp_collapse_${gid}`, 'true');
			} else {
				el.classList.remove('collapsed');
				if (icon) {
					icon.classList.remove('fa-chevron-right');
					icon.classList.add('fa-chevron-down');
				}
				localStorage.setItem(`grp_collapse_${gid}`, 'false');
			}
		});
	}
	
	const groupActionModal = new bootstrap.Modal(document.getElementById('groupActionModal'));

	function openGroupModal(mode, targetId, currentName = '', event = null) {
		if(event) event.stopPropagation();

		document.getElementById('ga_mode').value = mode;
		document.getElementById('ga_targetId').value = targetId;
		document.getElementById('ga_nameInput').value = mode === 'rename' ? currentName : '';
		document.getElementById('groupActionTitle').innerText = mode === 'add' ? 'Add Group' : 'Rename Group';
		
		groupActionModal.show();
		
		setTimeout(() => document.getElementById('ga_nameInput').focus(), 500);
	}

	async function submitGroupAction() {
		const mode = document.getElementById('ga_mode').value;
		const targetId = document.getElementById('ga_targetId').value; 
		const name = document.getElementById('ga_nameInput').value.trim();
		
		if (!name) return showToast("Name cannot be empty", "error");

		groupActionModal.hide();

		if (mode === 'add') {
			await fetch("/api/group/add", {
				method: "POST", headers: {"Content-Type":"application/json"},
				body: JSON.stringify({ name: name, parent_id: targetId })
			});
		} else {
			await fetch("/api/group/update", {
				method: "POST", headers: {"Content-Type":"application/json"},
				body: JSON.stringify({ id: targetId, name: name })
			});
		}
		
		loadGroups();
	}

	function confirmDeleteGroup(id) {
		showModalConfirm("Are you sure to delete this group and sub-groups?<br>Hosts will be moved to the Default Group.", async () => {
			await fetch("/api/group/delete", {
				method: "POST", headers: {"Content-Type":"application/json"},
				body: JSON.stringify({ id: id })
			});
			loadGroups();
			loadClients();
		});
	}

    function toggleAllClients(src) { document.querySelectorAll('.client-checkbox').forEach(c=>c.checked=src.checked); updateBatchUI(); }
    function toggleGroup(src) { document.getElementById(src.dataset.target).querySelectorAll('.client-checkbox').forEach(c=>c.checked=src.checked); updateBatchUI(); }
    function updateBatchUI() { 
        let c=document.querySelectorAll('.client-checkbox:checked').length; 
        document.querySelectorAll('.group-checkbox').forEach(gc=>{ let g=document.getElementById(gc.dataset.target), t=g.querySelectorAll('.client-checkbox').length, ch=g.querySelectorAll('.client-checkbox:checked').length; gc.checked=(t>0&&t===ch); gc.indeterminate=(ch>0&&ch<t); });
    }
    function getSelectedIPs() { let r=[]; document.querySelectorAll('.client-checkbox:checked').forEach(c=>r.push(c.value)); return r; }
    function sel(id, n, on) { 
		if (curClient === id) return; 
		
		curClient=id; 
		document.getElementById("currentHostName").innerText=n; 
		document.getElementById("currentHostIp").innerText=id; 
		document.getElementById("btnStartMonitor").disabled=!on; 
		
		toggleScreen(false); 
		
        let img = document.getElementById("screenDisplay");
        let ph = document.getElementById("screenPlaceholder");
        let statusBadge = document.getElementById("screenStatus");

        img.style.display = "none"; 
        img.src = "";               
        img.style.cursor = "default";

        ph.style.display = "block";
        ph.innerHTML = '<i class="fas fa-desktop fs-1 mb-3 opacity-25"></i><div>Click Start to Monitor</div>';

        statusBadge.innerText = "Stopped";
        statusBadge.className = "badge bg-secondary d-flex align-items-center";

        document.getElementById("psTableBody").innerHTML = '';
        allProcs = []; 
        currentPath = "C:\\";
        document.getElementById("filePath").value = currentPath;
        document.getElementById("fileTableBody").innerHTML = ''; 
		
		loadClients(); 
		if(on) {
			loadSysInfo(); 
			if(typeof loadDrives === "function") loadDrives();
		} else {
			['cpu','mem','disk','net','os','time'].forEach(k=>document.getElementById(k+'Info').innerText = "---");
			if(typeof renderDefaultDrives === "function") renderDefaultDrives();
		}
	}
    
    function showAddModal() { 
		document.getElementById("modalTitle").innerText = "Add Host";
        document.getElementById("idDisplayRow").style.display="none"; 
        
        document.getElementById("addId").value = ""; 
        document.getElementById("editingIp").value = "";
        
        document.getElementById("addIp").value = "";
        document.getElementById("addAlias").value = "";
        document.getElementById("addGroup").value = "";
        
        document.getElementById("addPass").value = "{{.DefaultPass}}"; 
        
        document.getElementById("addIp").readOnly = false; 
        document.getElementById("editMode").value = "active"; 
        
        new bootstrap.Modal('#addModal').show(); 
    }
    function editClient(id, a, gid, p, m) { 
		document.getElementById("modalTitle").innerText = "Edit Host";
        document.getElementById("editingIp").value = id; 
        
        let currentIp = clientDataMap[id] ? clientDataMap[id].ip : id;
        document.getElementById("addIp").value = currentIp; 
        
        document.getElementById("addIp").readOnly = false; 
        
        document.getElementById("idDisplayRow").style.display = "block"; 
        document.getElementById("addId").value = id; 
        document.getElementById("addAlias").value = a; 
        document.getElementById("addGroup").value = gid; 
        document.getElementById("addPass").value = p; 
        document.getElementById("editMode").value = m || "active"; 
        
        new bootstrap.Modal('#addModal').show(); 
    }
    async function saveClient() { 
		await fetch("/api/client/add", {
			method:"POST", 
			headers:{"Content-Type":"application/json"}, 
			body:JSON.stringify({
				id: document.getElementById("addId").value, 
				ip: document.getElementById("addIp").value, 
				alias: document.getElementById("addAlias").value, 
				group_id: document.getElementById("addGroup").value, 
				password: document.getElementById("addPass").value,
				mode: document.getElementById("editMode").value
			})
		}); 
		loadClients(); 
		bootstrap.Modal.getInstance(document.getElementById('addModal')).hide(); 
	}
    async function removeClient(ip) { showModalConfirm(`Are you sure to delete ${ip}?`, async () => { await fetch("/api/client/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ip})}); if(ip===curClient) location.reload(); showToast("Deleted"); loadClients(); }); }
    async function batchDeleteClients() { 
        let ips = getSelectedIPs(); 
        
        if (ips.length === 0) {
            showToast("Please select hosts to delete first", "warning"); 
            return;
        }

        showModalConfirm(`Are you sure to delete selected ${ips.length} hosts?`, async () => { 
            try {
                await Promise.all(ips.map(ip => fetch("/api/client/remove", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ip })
                })));
                
                showToast("Delete successful");
                
                let selectAllCheckbox = document.getElementById('selectAllClients');
                if(selectAllCheckbox) selectAllCheckbox.checked = false;

                loadClients(); 
            } catch(e) {
                showToast("Delete failed: " + e, "error");
            }
        }); 
    }
    
    async function dlCfg() { let c={port:document.getElementById("cfgPort").value, password:document.getElementById("cfgPass").value, autostart:document.getElementById("cfgAutostart").checked, passive_mode:document.getElementById("cfgPassiveMode").checked, server_addr:document.getElementById("cfgServerAddr").value, server_port:document.getElementById("cfgServerPort").value, server_pass:document.getElementById("cfgServerPass").value, check_interval: parseInt(document.getElementById("cfgCheckInterval").value) || 30}; let b=await(await fetch("/api/generate_config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})).blob(); let a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="config.dat"; a.click(); }
    
	let groupsRaw = []; 
	let groupsTree = []; 

	async function loadGroups() { 
		let r = await fetch("/api/groups"); 
		groupsRaw = await r.json(); 
		buildGroupTree();
		renderClientList(allClientsCache); 
		updateGroupSelects(); 
	}
	
	function buildGroupTree() {
		let map = {};
		groupsRaw.forEach(g => { g.children = []; map[g.id] = g; });
		groupsTree = [];
		groupsRaw.forEach(g => {
			if (g.parent_id && map[g.parent_id]) {
				map[g.parent_id].children.push(g);
			} else {
				groupsTree.push(g);
			}
		});
		const sortFn = (a,b) => a.sort_order - b.sort_order;
		groupsTree.sort(sortFn);
		groupsRaw.forEach(g => g.children.sort(sortFn));
	}

    function renderGroupList() {
		document.getElementById("groupList").innerHTML = groups.map(g => `
			<div class="list-group-item d-flex justify-content-between align-items-center p-2">
				<span class="text-truncate" title="${g}">${g}</span>
				<div class="d-flex gap-2">
					<button class="btn btn-sm text-primary p-0" onclick="openRenameModal('${g}')" title="Rename">
						<i class="fas fa-edit"></i>
					</button>
					<button class="btn btn-sm text-danger p-0" onclick="deleteGroup('${g}')" title="Delete">
						<i class="fas fa-times"></i>
					</button>
				</div>
			</div>
		`).join('');
	}
	
	function openRenameModal(oldName) {
		document.getElementById('renameOldName').value = oldName;
		document.getElementById('renameOldNameDisplay').value = oldName;
		document.getElementById('renameNewName').value = oldName; 
		
		const modal = new bootstrap.Modal(document.getElementById('groupRenameModal'));
		modal.show();
		
		setTimeout(() => document.getElementById('renameNewName').focus(), 500);
	}

	
	async function confirmRenameGroup() {
		const oldName = document.getElementById('renameOldName').value;
		const newName = document.getElementById('renameNewName').value.trim();
		
		if (!newName) {
			showToast("New name cannot be empty", "error");
			return;
		}
		if (newName === oldName) {
			bootstrap.Modal.getInstance(document.getElementById('groupRenameModal')).hide();
			return;
		}
		if (groups.includes(newName)) {
			showToast("Group name already exists", "error");
			return;
		}

		const renameModal = bootstrap.Modal.getInstance(document.getElementById('groupRenameModal'));
		renameModal.hide();
		
		showToast("Processing rename...", "info");

		try {
			await fetch("/api/group/add", {
				method: "POST", headers: {"Content-Type": "application/json"}, 
				body: JSON.stringify({name: newName})
			});

			let r = await fetch("/api/clients?t="+Date.now());
			let latestClients = await r.json();
			
			let clientsToMove = latestClients.filter(c => c.group === oldName);
			
			const movePromises = clientsToMove.map(c => 
				fetch("/api/client/add", {
					method: "POST", headers: {"Content-Type": "application/json"},
					body: JSON.stringify({
						id: c.id, 
						ip: c.ip, 
						alias: c.alias, 
						password: c.password,
						group: newName, 
						mode: c.mode
					})
				})
			);
			
			await Promise.all(movePromises);

			await fetch("/api/group/delete", {
				method: "POST", headers: {"Content-Type": "application/json"}, 
				body: JSON.stringify({name: oldName})
			});

			showToast(`Group renamed to "${newName}"`);
			
			await loadGroups();
			await loadClients();

		} catch (e) {
			console.error(e);
			showToast("Rename failed, check console", "error");
		}
	}

    async function addGroup() { 
        let n = document.getElementById("newGroupName").value; 
        if (n) {
            await fetch("/api/group/add", {
                method: "POST", 
                headers: {"Content-Type": "application/json"}, 
                body: JSON.stringify({name: n})
            }); 
            document.getElementById("newGroupName").value = "";
            loadGroups(); 
        }
    }
	
	async function deleteGroup(id) {
		if(!confirm("Delete this group and its sub-groups? Hosts will be moved to root.")) return;
		await fetch("/api/group/delete", {
			method: "POST", headers: {"Content-Type":"application/json"},
			body: JSON.stringify({ id: id })
		});
		loadGroups();
		loadClients();
	}
	
	function renameGroup(oldName) {
        let newName = prompt("Enter new group name:", oldName);
        
        if (newName && newName.trim() !== "" && newName !== oldName) {
            newName = newName.trim();
            showToast("Renaming...", "info");
            
            (async () => {
                try {
                    await fetch("/api/group/add", {
                        method: "POST", headers: {"Content-Type": "application/json"}, 
                        body: JSON.stringify({name: newName})
                    });

                    let clientsToMove = allClientsCache.filter(c => c.group === oldName);
                    
                    for (let c of clientsToMove) {
                        await fetch("/api/client/add", {
                            method: "POST", headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({
                                id: c.id, 
                                ip: c.ip, 
                                alias: c.alias, 
                                password: c.password,
                                group: newName, 
                                mode: c.mode
                            })
                        });
                    }

                    await fetch("/api/group/delete", {
                        method: "POST", headers: {"Content-Type": "application/json"}, 
                        body: JSON.stringify({name: oldName})
                    });

                    showToast("Rename successful");
                    loadGroups();
                    loadClients(); 
                } catch (e) {
                    showToast("Rename failed: " + e, "error");
                    console.error(e);
                }
            })();
        }
    }
	
    function updateGroupSelects() {
		const s = document.getElementById("addGroup");
		if(!s) return;
		
		let html = '<option value="">Root (No group)</option>';
		
		function buildOptions(nodes, depth) {
			nodes.forEach(g => {
				let prefix = "&nbsp;".repeat(depth * 4) + (depth > 0 ? "‚îî‚îÄ " : "");
				html += `<option value="${g.id}">${prefix}${g.name}</option>`;
				if (g.children) buildOptions(g.children, depth + 1);
			});
		}
		
		buildOptions(groupsTree, 0);
		s.innerHTML = html;
	}

    // USB
    let usbPage=1, usbTotal=0;
    async function loadUSBRecords() {
        let q = `?page=${usbPage}&page_size=${document.getElementById("usbPageSize").value}&client_id=${document.getElementById("usbClientFilter").value}&keyword=${encodeURIComponent(document.getElementById("usbKeyword").value)}`;
        if(document.getElementById("usbStart").value) q+=`&start_date=${document.getElementById("usbStart").value}`;
        if(document.getElementById("usbEnd").value) q+=`&end_date=${document.getElementById("usbEnd").value}`;
        let res = await (await fetch("/api/usb/records"+q)).json();
        usbTotal = res.total; document.getElementById("usbPageInfo").innerText = `Page ${usbPage} / ${Math.ceil(usbTotal/document.getElementById("usbPageSize").value)||1} Pages`;
        document.getElementById("usbRecordsBody").innerHTML = !res.data||!res.data.length ? '<tr><td colspan="6" class="text-center text-muted py-3">No records</td></tr>' : res.data.map(r=>{
            let c=clientDataMap[r.client_ip], cn=c?`${c.ip} (${r.client_ip})`:r.client_ip;
            return `<tr><td class="ps-3 small font-monospace">${r.timestamp}</td><td title="${cn}"><div class="text-truncate" style="max-width:120px">${cn}</div></td><td><span class="badge ${r.action==='Insert' || r.action==='ÊèíÂÖ•'?'bg-success':'bg-warning text-dark'}">${r.action}</span></td><td class="fw-bold">${r.device_name}</td><td>${r.model||'-'}</td><td class="font-monospace small text-muted">${r.volume_id||'-'}</td></tr>`;
        }).join('');
    }
    function updateUSBFilter() { let s = document.getElementById("usbClientFilter"), v=s.value; s.innerHTML='<option value="">All</option>'; allClientsCache.forEach(c=>s.innerHTML+=`<option value="${c.id||c.ip}">${c.alias||c.ip}</option>`); s.value=v; }
    function changeUsbPage(d) { let n=usbPage+d; if(n>=1 && n<=Math.ceil(usbTotal/document.getElementById("usbPageSize").value)) { usbPage=n; loadUSBRecords(); } }
    async function exportUSB(m) {
        let q = `?page=${m==='all'?1:usbPage}&page_size=${m==='all'?100000:document.getElementById("usbPageSize").value}&client_id=${document.getElementById("usbClientFilter").value}`;
        let res = await (await fetch("/api/usb/records"+q)).json();
        if(!res.data) return showToast("No data","error");
        let rows = ["Time\tIP\tAction\tDevice\tModel\tID"]; res.data.forEach(r=>{ let c=clientDataMap[r.client_ip]; rows.push(`${r.timestamp}\t${c?c.ip:r.client_ip}\t${r.action}\t${r.device_name}\t${r.model}\t${r.volume_id}`); });
        let b = new Uint8Array(rows.join("\r\n").length*2+2); b[0]=0xFF; b[1]=0xFE; for(let i=0; i<rows.join("\r\n").length; i++) { let c=rows.join("\r\n").charCodeAt(i); b[i*2+2]=c&0xFF; b[i*2+3]=(c>>8)&0xFF; }
        let a = document.createElement("a"); a.href=URL.createObjectURL(new Blob([b],{type:'text/csv;charset=utf-16le'})); a.download="usb.csv"; a.click();
    }
    async function saveServerSettings() {
        try {
            const res = await fetch("/api/config/update_settings", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({file_threshold:parseInt(document.getElementById('batchFileThreshold').value)||10, temp_file_ttl:parseInt(document.getElementById('tempFileTTL').value)||60})});
            if(res.ok) showToast("Settings saved"); else showToast("Save failed","error");
        } catch(e) { showToast("Error","error"); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{ loadClients(); loadGroups(); if(document.getElementById('cfgPassiveMode')) document.getElementById('cfgPassiveMode').addEventListener('change', function() { document.getElementById('passiveModeSettings').style.display = this.checked ? 'block' : 'none'; }); });
	

    let ledgerCache = {}; 
    let ledgerPage = 1;

    function sendReqTo(targetId, type, payload) {
        fetch("/api/send", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({target_id: targetId, type: type, payload: payload})
        });
    }

    // Open modal
    function openLedgerModal() {
        const modal = new bootstrap.Modal(document.getElementById('ledgerModal'));
        modal.show();
        
        renderLedgerTable();
        
        setTimeout(refreshLedgerInfo, 200); 
    }

    // Batch request online host info
    function refreshLedgerInfo() {
        let count = 0;
        
        allClientsCache.forEach(c => {
            if (c.is_online) {
                let targetId = c.id || c.ip;
                
                ws.send(JSON.stringify({
                    type: "forward_to_agent",
                    target_id: targetId,
                    payload: { 
                        type: "sys_info", 
                        payload: "" 
                    }
                }));
                count++;
            }
        });

        if(count > 0) {
            showToast(`Getting info for ${count} online hosts...`, "info");
        } else {
            showToast("No online hosts", "warning");
        }
    }

    function updateLedgerCache(id, info) {
        ledgerCache[id] = info;
        if (document.getElementById('ledgerModal').classList.contains('show')) {
            renderLedgerTable();
        }
    }

    function getGroupPath(groupId, legacyName) {
        if (!groupId) return legacyName || "Default Group";
        
        let path = [];
        let currId = groupId;
        let safety = 0; 
        
        while(currId && safety < 20) {
            let g = groupsRaw.find(x => x.id === currId);
            if(g) {
                path.unshift(g.name);
                currId = g.parent_id;
            } else {
                break;
            }
            safety++;
        }
        
        return path.length > 0 ? path.join(" / ") : (legacyName || "Default Group");
    }
	
    // Render table
    function renderLedgerTable() {
        const tbody = document.getElementById("ledgerTableBody");
        const searchText = document.getElementById("ledgerSearch").value.toLowerCase();
        const filterStatus = document.getElementById("ledgerFilter").value;
        const pageSize = parseInt(document.getElementById("ledgerPageSize").value);

        let filtered = allClientsCache.filter(c => {
            let matchText = (c.alias||"").toLowerCase().includes(searchText) || 
                            c.ip.toLowerCase().includes(searchText) || 
                            (c.id||"").toLowerCase().includes(searchText);
            let matchStatus = true;
            if (filterStatus === 'online') matchStatus = c.is_online;
            if (filterStatus === 'offline') matchStatus = !c.is_online;
            
            return matchText && matchStatus;
        });

        const total = filtered.length;
        const totalPages = Math.ceil(total / pageSize) || 1;
        if (ledgerPage > totalPages) ledgerPage = totalPages;
        if (ledgerPage < 1) ledgerPage = 1;
        
        document.getElementById("ledgerPageInfo").innerText = `Page ${ledgerPage} / ${totalPages} (Total: ${total})`;

        const start = (ledgerPage - 1) * pageSize;
        const pageData = filtered.slice(start, start + pageSize);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">No matching data</td></tr>';
            return;
        }

        tbody.innerHTML = pageData.map(c => {
            let info = ledgerCache[c.id || c.ip] || {};
            if (!c.is_online) info = {}; 

            let statusHtml = c.is_online 
                ? '<span class="badge bg-success">Online</span>' 
                : '<span class="badge bg-secondary">Offline</span>';
            
            let groupName = getGroupPath(c.group_id, c.group);

            return `<tr>
                <td class="ps-3 fw-bold text-secondary">${c.alias || '-'}</td>
                <td class="small text-muted" title="${groupName}"><div class="text-truncate" style="max-width: 150px;">${groupName}</div></td>
                <td class="font-monospace">${c.ip}</td>
                <td class="small text-muted font-monospace user-select-all" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${c.id || '-'}</td>
                <td>${statusHtml}</td>
                <td class="small" title="${info.os||''}"><div class="text-truncate" style="max-width:150px">${info.os || '-'}</div></td>
                <td class="small" title="${info.cpu||''}"><div class="text-truncate" style="max-width:200px">${info.cpu || '-'}</div></td>
                <td class="small">${info.memory ? parseMem(info.memory) : '-'}</td>
            </tr>`;
        }).join('');
    }

    // Simple memory format helper
    function parseMem(memStr) {
        if(!memStr) return '-';
        let parts = memStr.split('|');
        return parts[0] || memStr;
    }

    function changeLedgerPage(d) {
        ledgerPage += d;
        renderLedgerTable();
    }

    // Export function
    function exportLedger(scope) {
        const searchText = document.getElementById("ledgerSearch").value.toLowerCase();
        const filterStatus = document.getElementById("ledgerFilter").value;

        let dataToExport = allClientsCache.filter(c => {
             let matchText = (c.alias||"").toLowerCase().includes(searchText) || 
                            c.ip.toLowerCase().includes(searchText) || 
                            (c.id||"").toLowerCase().includes(searchText);
            let matchStatus = true;
            if (filterStatus === 'online') matchStatus = c.is_online;
            if (filterStatus === 'offline') matchStatus = !c.is_online;
            return matchText && matchStatus;
        });

        if (scope === 'current') {
            const pageSize = parseInt(document.getElementById("ledgerPageSize").value);
            const start = (ledgerPage - 1) * pageSize;
            dataToExport = dataToExport.slice(start, start + pageSize);
        }

        let rows = ["Alias\tGroup\tIP\tID\tStatus\tOS\tCPU\tMemory"];
        
        dataToExport.forEach(c => {
            let info = ledgerCache[c.id || c.ip] || {};
            if (!c.is_online && !ledgerCache[c.id || c.ip]) info = {};
            
            const clean = (str) => (str || '-').toString().replace(/[\r\n\t]/g, " ");
            
            let memStr = clean(info.memory);
            if(memStr !== '-') memStr = memStr.split('|')[0] || memStr; 

            let groupName = getGroupPath(c.group_id, c.group);

            let row = [
                clean(c.alias),
                clean(groupName),
                clean(c.ip),
                clean(c.id),
                c.is_online ? "Online" : "Offline",
                clean(info.os),
                clean(info.cpu),
                memStr
            ];
            rows.push(row.join("\t"));
        });

        let content = rows.join("\r\n");
        let b = new Uint8Array(content.length * 2 + 2);
        b[0] = 0xFF; b[1] = 0xFE; 
        
        for (let i = 0; i < content.length; i++) {
            let c = content.charCodeAt(i);
            b[i * 2 + 2] = c & 0xFF;
            b[i * 2 + 3] = (c >> 8) & 0xFF;
        }

        const blob = new Blob([b], { type: 'text/csv;charset=utf-16le' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Device_Inventory_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
	
	function adjustQuality(rtt) {
        const mode = document.getElementById("qualitySelect").value;
        if (mode !== 'auto') return;

        if (rtt < 100) {
            autoQuality += 5; autoScale += 0.05;
        } else if (rtt < 200) {
            autoQuality += 2; autoScale += 0.02;
        } else if (rtt > 800) {
            autoQuality -= 10; autoScale -= 0.1;
        } else if (rtt > 500) {
            autoQuality -= 5; autoScale -= 0.05;
        }
        
        if (autoQuality > 90) autoQuality = 90;
        if (autoQuality < 10) autoQuality = 10;
        if (autoScale > 1.0) autoScale = 1.0;
        if (autoScale < 0.3) autoScale = 0.3;
    }
	
	function manualQualityChange() {
        const mode = document.getElementById("qualitySelect").value;
        if(mode !== 'auto') showToast("Switched to manual quality mode");
        else showToast("Switched to auto quality mode");
    }
	document.getElementById("screenDisplay").ondragstart = function() { return false; };
</script>
</body>
</html>
